import { NextRequest, NextResponse } from 'next/server';

export async function POST(request: NextRequest) {
  try {
    // Verify webhook secret
    const authHeader = request.headers.get('authorization');
    const expectedToken = process.env.WEBHOOK_SECRET;

    if (!expectedToken || authHeader !== `Bearer ${expectedToken}`) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
    }

    const body = await request.json();
    const { user_id, user_role, previous_messages_count = 0 } = body;

    if (!user_id) {
      return NextResponse.json(
        {
          error: 'Missing required field: user_id',
        },
        { status: 400 }
      );
    }

    const aiProvider = process.env.AI_PROVIDER || 'claude';
    let generatedMessage: string;

    try {
      if (aiProvider === 'claude') {
        generatedMessage = await generateClaudeMessage(
          user_role,
          previous_messages_count
        );
      } else if (aiProvider === 'claude-web') {
        generatedMessage = await generateClaudeWeb(
          user_role,
          previous_messages_count
        );
      } else if (aiProvider === 'openai') {
        generatedMessage = await generateOpenAIMessage(
          user_role,
          previous_messages_count
        );
      } else if (aiProvider === 'chatgpt-web') {
        generatedMessage = await generateChatGPTWeb(
          user_role,
          previous_messages_count
        );
      } else {
        // Fallback for testing
        generatedMessage = generateTestMessage(
          user_role,
          previous_messages_count
        );
      }
    } catch (error) {
      console.error(
        `${aiProvider} error, falling back to test messages:`,
        error
      );
      generatedMessage = generateTestMessage(
        user_role,
        previous_messages_count
      );
    }

    return NextResponse.json({
      success: true,
      message: generatedMessage,
      user_id,
      provider: aiProvider,
      generated_at: new Date().toISOString(),
    });
  } catch (error) {
    console.error('Message generation webhook error:', error);
    return NextResponse.json(
      {
        error: 'Failed to generate message',
        details: error instanceof Error ? error.message : 'Unknown error',
      },
      { status: 500 }
    );
  }
}

async function generateClaudeMessage(
  userRole?: string,
  previousCount: number = 0
): Promise<string> {
  const claudeApiKey = process.env.CLAUDE_API_KEY;

  if (!claudeApiKey) {
    throw new Error('Claude API key not configured');
  }

  // Customize prompt based on user role and message history
  const roleContext = getRoleContext(userRole);
  const varietyPrompt = getVarietyPrompt(previousCount);

  const prompt = `${roleContext}

${varietyPrompt}

GÃ©nÃ¨re UN SEUL message quotidien en franÃ§ais (50-140 caractÃ¨res) :
- Ton positif et bienveillant
- AxÃ© sur le bien-Ãªtre mental ou la gratitude  
- Personnel et inspirant
- Avec un emoji si appropriÃ©

Exemples :
"Aujourd'hui, respire profondÃ©ment. Ton calme intÃ©rieur est ta force. ğŸŒ¸"
"Chaque petite victoire compte. CÃ©lÃ¨bre tes progrÃ¨s. âœ¨"

IMPORTANT: RÃ©ponds UNIQUEMENT avec le message final, rien d'autre.`;

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': claudeApiKey,
      'anthropic-version': '2023-06-01',
    },
    body: JSON.stringify({
      model: 'claude-3-haiku-20240307', // Fast and cost-effective
      max_tokens: 100,
      temperature: 0.8,
      messages: [
        {
          role: 'user',
          content: prompt,
        },
      ],
    }),
  });

  if (!response.ok) {
    const errorData = await response.text();
    throw new Error(`Claude API error: ${response.status} ${errorData}`);
  }

  const data = await response.json();
  const message = data.content[0]?.text?.trim();

  if (!message) {
    throw new Error('No message generated by Claude');
  }

  // Clean up the message (remove quotes, extra formatting)
  return cleanMessage(message);
}

async function generateOpenAIMessage(
  userRole?: string,
  previousCount: number = 0
): Promise<string> {
  const openaiApiKey = process.env.OPENAI_API_KEY;

  if (!openaiApiKey) {
    throw new Error('OpenAI API key not configured');
  }

  const roleContext = getRoleContext(userRole);
  const varietyPrompt = getVarietyPrompt(previousCount);

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${openaiApiKey}`,
    },
    body: JSON.stringify({
      model: 'gpt-4o-mini',
      max_tokens: 100,
      temperature: 0.8,
      messages: [
        {
          role: 'system',
          content: `Tu es un assistant bienveillant spÃ©cialisÃ© en santÃ© mentale. ${roleContext} ${varietyPrompt} GÃ©nÃ¨re un message quotidien court et positif en franÃ§ais (50-140 caractÃ¨res) axÃ© sur le bien-Ãªtre mental, la pleine conscience ou la positivitÃ©. Le message doit Ãªtre personnel, encourageant et adaptÃ© pour un SMS. Ã‰vite les platitudes gÃ©nÃ©riques. Sois crÃ©atif et unique.`,
        },
        {
          role: 'user',
          content: 'GÃ©nÃ¨re un message unique de bien-Ãªtre mental quotidien.',
        },
      ],
    }),
  });

  if (!response.ok) {
    const errorData = await response.text();
    throw new Error(`OpenAI API error: ${response.status} ${errorData}`);
  }

  const data = await response.json();
  const message = data.choices[0]?.message?.content?.trim();

  if (!message) {
    throw new Error('No message generated by OpenAI');
  }

  return cleanMessage(message);
}

function getRoleContext(userRole?: string): string {
  switch (userRole) {
    case 'Personnel':
      return "Tu t'adresses Ã  une personne cherchant un dÃ©veloppement personnel quotidien.";
    case 'Famille':
      return "Tu t'adresses Ã  quelqu'un partageant ce bien-Ãªtre avec sa famille.";
    case 'Cadeau':
      return "Tu t'adresses Ã  quelqu'un qui reÃ§oit ces messages comme un cadeau bienveillant.";
    default:
      return "Tu t'adresses Ã  une personne souhaitant amÃ©liorer son bien-Ãªtre quotidien.";
  }
}

function getVarietyPrompt(previousCount: number): string {
  if (previousCount > 50) {
    return 'Cette personne reÃ§oit des messages depuis longtemps. Sois particuliÃ¨rement crÃ©atif et Ã©vite les thÃ¨mes rÃ©pÃ©titifs.';
  } else if (previousCount > 10) {
    return "Cette personne a dÃ©jÃ  reÃ§u plusieurs messages. Assure-toi d'Ãªtre original.";
  }
  return 'GÃ©nÃ¨re un message engageant pour motiver cette personne.';
}

async function generateClaudeWeb(
  userRole?: string,
  previousCount: number = 0
): Promise<string> {
  const serviceUrl = process.env.CLAUDE_SERVICE_URL || 'http://localhost:3001';
  const webhookSecret = process.env.WEBHOOK_SECRET;

  if (!webhookSecret) {
    throw new Error('Webhook secret not configured');
  }

  const response = await fetch(`${serviceUrl}/generate-message`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      Authorization: `Bearer ${webhookSecret}`,
    },
    body: JSON.stringify({
      user_id: 'webhook-request',
      user_role: userRole,
      previous_messages_count: previousCount,
    }),
  });

  if (!response.ok) {
    const errorData = await response.text();
    throw new Error(
      `Claude web service error: ${response.status} ${errorData}`
    );
  }

  const data = await response.json();

  if (!data.success || !data.message) {
    throw new Error('Invalid response from Claude web service');
  }

  return data.message;
}

async function generateChatGPTWeb(
  userRole?: string,
  previousCount: number = 0
): Promise<string> {
  // This would require a running puppeteer instance
  // For now, return a placeholder - implement based on your setup
  throw new Error('ChatGPT web automation not implemented - use test messages');
}

function generateTestMessage(
  userRole?: string,
  previousCount: number = 0
): string {
  const testMessages = [
    "Aujourd'hui, respire profondÃ©ment. Ton calme intÃ©rieur est ta force. ğŸŒ¸",
    'Chaque petite victoire compte. CÃ©lÃ¨bre tes progrÃ¨s, mÃªme les plus discrets. âœ¨',
    'Prends un moment pour toi. Tu mÃ©rites cette pause bien-Ãªtre. ğŸ’™',
    "La gratitude transforme ce que nous avons en suffisant. Merci pour aujourd'hui. ğŸ™",
    "Ton sourire a le pouvoir d'illuminer ta journÃ©e et celle des autres. ğŸ˜Š",
    'Rappelle-toi : tu es plus fort que tes dÃ©fis du moment. ğŸ’ª',
    'Une pensÃ©e positive peut changer toute ta journÃ©e. Choisis la bienveillance. ğŸŒŸ',
    "Prendre soin de soi n'est pas Ã©goÃ¯ste, c'est essentiel. ğŸŒ¿",
    "Aujourd'hui, sois fier des petits pas que tu fais vers tes rÃªves. ğŸ¦‹",
    "Ton bien-Ãªtre commence par l'acceptation de qui tu es maintenant. ğŸ’š",
  ];

  // Use modulo to cycle through messages based on previous count
  const index = previousCount % testMessages.length;
  return testMessages[index];
}

function cleanMessage(message: string): string {
  // Remove quotes and clean formatting
  return message
    .replace(/^["']|["']$/g, '') // Remove leading/trailing quotes
    .replace(/^\s*-\s*/, '') // Remove leading dash
    .trim();
}

// Only allow POST requests
export async function GET() {
  return NextResponse.json({ error: 'Method not allowed' }, { status: 405 });
}
